# Helpers


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## Helper Functions

These helper functions provide convenient patterns for common workflow
operations.

### get_job_session_info

Retrieve job-related display information from session with fallbacks to
job attributes.

------------------------------------------------------------------------

<a
href="https://github.com/cj-mills/cjm-fasthtml-workflows/blob/main/cjm_fasthtml_workflows/core/helpers.py#L15"
target="_blank" style="float:right; font-size:smaller">source</a>

### get_job_session_info

>  get_job_session_info (job_id:str, job:Any, sess:Any,
>                            fallback_fields:Optional[Dict[str,Any]]=None)

*Retrieve job-related display information from session with fallbacks.*

<table>
<colgroup>
<col style="width: 6%" />
<col style="width: 25%" />
<col style="width: 34%" />
<col style="width: 34%" />
</colgroup>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>job_id</td>
<td>str</td>
<td></td>
<td>Unique job identifier</td>
</tr>
<tr>
<td>job</td>
<td>Any</td>
<td></td>
<td>Job object (should have attributes like file_name, file_path,
plugin_id)</td>
</tr>
<tr>
<td>sess</td>
<td>Any</td>
<td></td>
<td>FastHTML session object</td>
</tr>
<tr>
<td>fallback_fields</td>
<td>Optional</td>
<td>None</td>
<td>Optional additional fallback fields</td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>Tuple</strong></td>
<td></td>
<td><strong>(file_info, plugin_info) dictionaries</strong></td>
</tr>
</tbody>
</table>

#### Example: get_job_session_info

``` python
from cjm_fasthtml_workflows.core.job_session import JobSessionManager

# Create mock job object
class MockJob:
    def __init__(self, job_id, file_name, file_path, plugin_id):
        self.id = job_id
        self.file_name = file_name
        self.file_path = file_path
        self.plugin_id = plugin_id

# Create session with stored metadata
session = {}
job_sess = JobSessionManager(session)
job_sess.store_job_metadata("job-123", {
    "file_info": {"name": "audio.mp3", "path": "/media/audio.mp3", "size": 5000},
    "plugin_info": {"title": "Whisper Large", "id": "whisper_large", "version": "3.0"}
})

# Create mock job
job = MockJob("job-123", "fallback.mp3", "/fallback/path", "fallback_plugin")

# Get info (should use session data, not fallback)
file_info, plugin_info = get_job_session_info("job-123", job, session)
print("File info:", file_info)
print("Plugin info:", plugin_info)
```

    File info: {'name': 'audio.mp3', 'path': '/media/audio.mp3', 'size': 5000}
    Plugin info: {'title': 'Whisper Large', 'id': 'whisper_large', 'version': '3.0'}

``` python
# Test with no session metadata (uses job attributes as fallback)
empty_session = {}
job2 = MockJob("job-456", "meeting.mp3", "/media/meeting.mp3", "whisper_base")

file_info2, plugin_info2 = get_job_session_info("job-456", job2, empty_session)
print("\nFile info (from job attrs):", file_info2)
print("Plugin info (from job attrs):", plugin_info2)
```


    File info (from job attrs): {'name': 'meeting.mp3', 'path': '/media/meeting.mp3'}
    Plugin info (from job attrs): {'title': 'whisper_base', 'id': 'whisper_base'}

``` python
# Test with additional fallback fields
file_info3, plugin_info3 = get_job_session_info(
    "job-789", 
    job2, 
    empty_session,
    fallback_fields={
        "file_info": {"format": "mp3", "duration": 120},
        "plugin_info": {"provider": "OpenAI"}
    }
)
print("\nFile info (with extra fallbacks):", file_info3)
print("Plugin info (with extra fallbacks):", plugin_info3)
```


    File info (with extra fallbacks): {'name': 'meeting.mp3', 'path': '/media/meeting.mp3', 'format': 'mp3', 'duration': 120}
    Plugin info (with extra fallbacks): {'title': 'whisper_base', 'id': 'whisper_base', 'provider': 'OpenAI'}

### once_per_job

Execute an operation once per job using automatic deduplication.

------------------------------------------------------------------------

<a
href="https://github.com/cj-mills/cjm-fasthtml-workflows/blob/main/cjm_fasthtml_workflows/core/helpers.py#L49"
target="_blank" style="float:right; font-size:smaller">source</a>

### once_per_job

>  once_per_job (sess:Any, job_id:str, operation:Callable[[],Any],
>                    tracker_id:str='default_operation')

*Execute an operation once per job using automatic deduplication.*

<table>
<colgroup>
<col style="width: 6%" />
<col style="width: 25%" />
<col style="width: 34%" />
<col style="width: 34%" />
</colgroup>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>sess</td>
<td>Any</td>
<td></td>
<td>FastHTML session object</td>
</tr>
<tr>
<td>job_id</td>
<td>str</td>
<td></td>
<td>Unique job identifier</td>
</tr>
<tr>
<td>operation</td>
<td>Callable</td>
<td></td>
<td>Callable to execute (should take no arguments)</td>
</tr>
<tr>
<td>tracker_id</td>
<td>str</td>
<td>default_operation</td>
<td>Unique identifier for this operation type</td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>Optional</strong></td>
<td></td>
<td><strong>Result of operation if executed, None if already
processed</strong></td>
</tr>
</tbody>
</table>

#### Example: once_per_job

``` python
# Simulate a session
session = {}

# Counter to track how many times operation is executed
execution_count = {'save': 0, 'notify': 0}

def save_to_disk(job_id, data):
    execution_count['save'] += 1
    print(f"  [SAVE] Saving {job_id}: {data}")
    return f"Saved {job_id}"

def send_notification(job_id):
    execution_count['notify'] += 1
    print(f"  [NOTIFY] Sending email for {job_id}")
    return f"Notified for {job_id}"

# First call - should execute
print("Call 1:")
result1 = once_per_job(
    session, "job-abc",
    lambda: save_to_disk("job-abc", {"text": "Hello"}),
    tracker_id="save_operation"
)
print(f"  Result: {result1}")

# Second call - should skip
print("\nCall 2 (duplicate):")
result2 = once_per_job(
    session, "job-abc",
    lambda: save_to_disk("job-abc", {"text": "Hello"}),
    tracker_id="save_operation"
)
print(f"  Result: {result2}")

print(f"\nTotal save operations: {execution_count['save']}")
```

    Call 1:
      [SAVE] Saving job-abc: {'text': 'Hello'}
      Result: Saved job-abc

    Call 2 (duplicate):
      Result: None

    Total save operations: 1

``` python
# Multiple operations for same job
print("\nMultiple operations for job-abc:")

# Save operation (already done, will skip)
once_per_job(
    session, "job-abc",
    lambda: save_to_disk("job-abc", {"text": "Hello"}),
    tracker_id="save_operation"
)

# Notification (first time, will execute)
once_per_job(
    session, "job-abc",
    lambda: send_notification("job-abc"),
    tracker_id="notification_operation"
)

# Notification again (duplicate, will skip)
once_per_job(
    session, "job-abc",
    lambda: send_notification("job-abc"),
    tracker_id="notification_operation"
)

print(f"\nTotal operations:")
print(f"  Saves: {execution_count['save']}")
print(f"  Notifications: {execution_count['notify']}")
print(f"\nSession state:")
session
```


    Multiple operations for job-abc:
      [NOTIFY] Sending email for job-abc

    Total operations:
      Saves: 1
      Notifications: 1

    Session state:

    {'dedup_save_operation': ['job-abc'],
     'dedup_notification_operation': ['job-abc']}

``` python
# Error handling - operation fails, not marked as processed
def failing_operation():
    print("  [ERROR] Operation failed!")
    raise ValueError("Simulated error")

print("\nTesting error handling:")
try:
    once_per_job(
        session, "job-xyz",
        failing_operation,
        tracker_id="save_operation"
    )
except ValueError as e:
    print(f"  Caught error: {e}")

# Check if job was marked as processed (it shouldn't be)
tracker = DeduplicationTracker(session, "save_operation")
print(f"\nJob-xyz marked as processed: {tracker.is_processed('job-xyz')}")
print("(False means we can retry the operation)")
```


    Testing error handling:
      [ERROR] Operation failed!
      Caught error: Simulated error

    Job-xyz marked as processed: False
    (False means we can retry the operation)
